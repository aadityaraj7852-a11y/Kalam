<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MCQ Tool — Final Fixed Version</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{--accent:#0b7a3e;--muted:#6b7280}
  body{font-family:Arial,Helvetica,sans-serif;background:#f7fafc;color:#0f172a;margin:12px}
  .wrap{display:flex;gap:12px;flex-wrap:wrap}
  .panel{background:#fff;border:1px solid #e6edf3;padding:12px;border-radius:8px;box-sizing:border-box}
  .left{flex:1;min-width:360px}
  .right{flex:1;min-width:360px;max-width:700px}
  input,textarea,select,button{font-size:14px}
  input,textarea,select{width:100%;padding:8px;margin:6px 0;border:1px solid #d1e2ef;border-radius:6px;box-sizing:border-box}
  textarea{min-height:70px;resize:vertical}
  label{font-weight:600;margin-top:6px;display:block}
  .row{display:flex;gap:8px}
  .row>div{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
  .btn-green{background:var(--accent);color:#fff}
  .btn-blue{background:#0b74ff;color:#fff}
  .btn-muted{background:#6b7280;color:#fff}
  .icon-btn{background:transparent;border:0;cursor:pointer;font-size:16px;padding:6px;color:#111}
  .card{border:1px solid #e6eef6;padding:10px;border-radius:8px;margin-bottom:10px;background:#fff}
  .muted{color:var(--muted);font-size:13px}
  .preview-table{width:100%;border-collapse:collapse;margin-top:8px}
  .preview-table td{border:1px solid #e2ecf6;padding:6px;vertical-align:top}
  .img-preview{max-width:220px;border:1px solid #e2ecf6;border-radius:6px;margin-top:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .small{font-size:13px;padding:6px 8px}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .title{font-size:18px;font-weight:700}
  .en-block{background:#f3f7ff;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #dbeafe}
  .toggle-en{cursor:pointer;background:transparent;border:0;color:#0b74ff;font-weight:600}
  .meta-row{display:flex;gap:10px;align-items:center}
  .number-badge{background:#eef2ff;color:#0b74ff;padding:4px 8px;border-radius:6px;font-weight:700}
</style>
</head>

<body>
<div style="max-width:1200px;margin:auto">
  <div class="toolbar" style="margin-bottom:10px">
    <div class="title">MCQ Editor — Final Updated Version</div>
    <div class="muted">Autosave · Translate Free · DOCX Export</div>
  </div>

  <div class="wrap">
    <div class="panel left">

      <label>Module</label>
      <input id="module" placeholder="Hindi / English / General">

      <label>Question</label>
      <textarea id="question" placeholder="Question लिखो..."></textarea>
      <label>Question Image</label>
      <input type="file" accept="image/*" id="questionImg">

      <div class="row">
        <div>
          <label>Option A</label><input id="optA">
          <label>Image A</label><input type="file" accept="image/*" id="imgA">
        </div>
        <div>
          <label>Option B</label><input id="optB">
          <label>Image B</label><input type="file" accept="image/*" id="imgB">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Option C</label><input id="optC">
          <label>Image C</label><input type="file" accept="image/*" id="imgC">
        </div>
        <div>
          <label>Option D</label><input id="optD">
          <label>Image D</label><input type="file" accept="image/*" id="imgD">
        </div>
      </div>

      <label>Answer</label><input id="answer">
      <label>Solution</label><textarea id="solution"></textarea>
      <label>Solution Image</label><input type="file" accept="image/*" id="solutionImg">

      <div class="row">
        <div><label>PM</label><input id="pm" value="1"></div>
        <div><label>NM</label><input id="nm" value="0.0"></div>
      </div>

      <label>Language</label>
      <select id="language">
        <option value="">auto</option>
        <option value="hi">hi</option>
        <option value="en">en</option>
      </select>

      <div class="actions" style="margin-top:8px">
        <button id="addBtn" class="btn btn-green"><i class="fa fa-plus"></i> Add</button>
        <button id="translateFormBtn" class="btn small" style="background:#ff8c00;color:#fff;">Translate Form</button>
        <button id="translateAllBtn" class="btn small" style="background:#0ea5ff;color:#fff;">Translate All</button>
        <button id="exportBtn" class="btn btn-blue"><i class="fa fa-file-word"></i> DOCX</button>
      </div>

      <label style="margin-top:8px">JSON Import</label>
      <textarea id="jsonArea" style="height:90px;font-family:monospace"></textarea>

      <div style="margin-top:8px" class="actions">
        <button id="importBtn" class="btn btn-muted">Import</button>
        <button id="exportJson" class="btn small" style="background:#444;color:#fff">Export JSON</button>
        <button id="clearBtn" class="btn small" style="background:#9ca3af;color:#fff">Clear</button>
      </div>

    </div>

    <div class="panel right">
      <div style="display:flex;justify-content:space-between;">
        <div style="font-weight:700">Preview</div>
      </div>

      <div id="list" style="margin-top:8px"></div>

      <div style="margin-top:10px" class="actions">
        <button id="removeLast" class="btn small" style="background:#ef4444;color:#fff">Remove Last</button>
        <button id="resetAll" class="btn small" style="background:#6b7280;color:#fff">Clear All</button>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------- STATE -------------------- */
const STORAGE_KEY = 'mcq_final_v3';
let questions = [];
let qCounter = 1;

const $ = id => document.getElementById(id);

function normalize(s){ return s ? s.replace(/\\n/g,"\n").replace(/\/n/g,"\n") : ""; }
function uid(){ return "q"+Math.random().toString(36).slice(2,10); }
function isHindi(s){ return /[\u0900-\u097F]/.test(s||''); }

function readFile(input){
  return new Promise(res=>{
    const f = input.files && input.files[0];
    if(!f) return res(null);
    const r = new FileReader();
    r.onload = ()=> res({type:f.type,dataURL:r.result});
    r.readAsDataURL(f);
  });
}

/* -------------------- LOAD -------------------- */
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    const obj = JSON.parse(raw);
    questions = obj.questions || [];
    qCounter = obj.qCounter || (questions.length+1);
  }
  renderList();
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({questions,qCounter}));
}

/* -------------------- ADD -------------------- */
$('addBtn').addEventListener('click', async ()=>{
  const qText = normalize($.question.value).trim();
  if(!qText) return alert("Question डालो");

  const ent = {
    id: uid(),
    no: qCounter,   // FIXED NUMBERING
    module: $.module.value.trim() || "General",
    question: qText,
    questionImg: await readFile($.questionImg),
    option: [
      normalize($.optA.value).trim(),
      normalize($.optB.value).trim(),
      normalize($.optC.value).trim(),
      normalize($.optD.value).trim()
    ],
    optionImg: [
      await readFile($.imgA),
      await readFile($.imgB),
      await readFile($.imgC),
      await readFile($.imgD)
    ],
    answer: $.answer.value.trim(),
    solution: normalize($.solution.value).trim(),
    solutionImg: await readFile($.solutionImg),
    pm: $.pm.value || "1",
    nm: $.nm.value || "0",
    language: $.language.value || (isHindi(qText) ? "hi" : "en"),

    questionEn: null,
    optionEn: [null,null,null,null],
    solutionEn: null
  };

  questions.push(ent);
  qCounter++;

  saveState();
  renderList();
  clearForm();
});

function clearForm(){
  $.module.value="";
  $.question.value="";
  $.questionImg.value="";
  $.optA.value=""; $.optB.value=""; $.optC.value=""; $.optD.value="";
  $.imgA.value=""; $.imgB.value=""; $.imgC.value=""; $.imgD.value="";
  $.answer.value=""; $.solution.value=""; $.solutionImg.value="";
  $.pm.value="1"; $.nm.value="0"; $.language.value="";
}

/* -------------------- PREVIEW -------------------- */
function renderList(){
  const list = $('list');
  list.innerHTML="";

  if(!questions.length){
    list.innerHTML = `<div class="muted">No questions yet.</div>`;
    return;
  }

  questions.forEach((q,idx)=>{
    const card = document.createElement("div");
    card.className="card";

    const hdr = document.createElement("div");
    hdr.style.display="flex";
    hdr.style.justifyContent="space-between";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.style.fontWeight="700";
    title.textContent = q.question;
    left.appendChild(title);

    const meta = document.createElement("div");
    meta.className="muted meta-row";
    const tag = document.createElement("span");
    tag.className="number-badge";
    tag.textContent = "#"+q.no;
    meta.appendChild(tag);

    const m2=document.createElement("span");
    m2.textContent = `${q.module} | ${q.language}`;
    meta.appendChild(m2);

    left.appendChild(meta);

    const right = document.createElement("div");
    right.style.display="flex"; right.style.gap="6px";

    right.appendChild(icon("fa-trash","Delete",()=>{ 
      if(confirm("Delete?")){ 
        questions = questions.filter(x=>x.id!==q.id);
        saveState(); renderList();
      }
    }));

    hdr.appendChild(left);
    hdr.appendChild(right);

    card.appendChild(hdr);

    /* Question text */
    const qd=document.createElement("div");
    qd.style.marginTop="8px";
    qd.textContent=q.question;
    qd.contentEditable=true;
    qd.oninput=()=>{ q.question=qd.textContent; saveState(); };
    card.appendChild(qd);

    if(q.questionImg){
      const im=document.createElement("img");
      im.src=q.questionImg.dataURL;
      im.className="img-preview";
      card.appendChild(im);
    }

    /* Options */
    const table=document.createElement("table");
    table.className="preview-table";
    ["A","B","C","D"].forEach((l,i)=>{
      const tr=document.createElement("tr");
      const td1=document.createElement("td"); td1.textContent=l;
      const td2=document.createElement("td");
      const ed=document.createElement("div");
      ed.textContent=q.option[i];
      ed.contentEditable=true;
      ed.oninput=()=>{ q.option[i]=ed.textContent; saveState(); };
      td2.appendChild(ed);

      if(q.optionImg[i]){
        const im=document.createElement("img");
        im.src=q.optionImg[i].dataURL;
        im.className="img-preview";
        td2.appendChild(im);
      }

      tr.appendChild(td1); tr.appendChild(td2);
      table.appendChild(tr);
    });

    card.appendChild(table);

    /* Answer */
    const ans=document.createElement("div");
    ans.style.marginTop="6px";
    ans.innerHTML=`<b>Answer:</b> <span contenteditable="true">${q.answer}</span>`;
    ans.querySelector("span").oninput=e=>{
      q.answer=e.target.textContent;
      saveState();
    };
    card.appendChild(ans);

    /* Solution */
    const sol=document.createElement("div");
    sol.style.marginTop="8px";
    sol.textContent=q.solution;
    sol.contentEditable=true;
    sol.oninput=()=>{ q.solution=sol.textContent; saveState(); };
    card.appendChild(sol);

    if(q.solutionImg){
      const im=document.createElement("img");
      im.src=q.solutionImg.dataURL;
      im.className="img-preview";
      card.appendChild(im);
    }

    list.appendChild(card);
  });
}

function icon(cls,title,fn){
  const b=document.createElement("button");
  b.className="icon-btn";
  b.innerHTML=`<i class="fa ${cls}"></i>`;
  b.title=title;
  b.onclick=fn;
  return b;
}

/* -------------------- JSON IMPORT -------------------- */
$('importBtn').addEventListener('click',()=>{
  const txt=$.jsonArea.value.trim();
  if(!txt) return alert("Paste JSON");

  try{
    const arr=JSON.parse(txt);
    const list = Array.isArray(arr) ? arr : [arr];

    list.forEach(o=>{
      const ent={
        id:uid(),
        no:qCounter,
        module:o.module||"General",
        question:normalize(o.question||""),
        questionImg:o.questionImg||null,
        option:(o.option||["","","",""]),
        optionImg:o.optionImg||[null,null,null,null],
        answer:o.answer||"",
        solution:normalize(o.solution||""),
        solutionImg:o.solutionImg||null,
        pm:o.pm||1,
        nm:o.nm||0,
        language:o.language||"",
        questionEn:o.questionEn||null,
        optionEn:o.optionEn||[null,null,null,null],
        solutionEn:o.solutionEn||null
      };
      questions.push(ent);
      qCounter++;
    });

    saveState();
    renderList();
    alert("Imported "+list.length);

  }catch(e){
    alert("Invalid JSON");
  }
});

/* -------------------- EXPORT JSON -------------------- */
$('exportJson').addEventListener('click',()=>{
  const out=questions.map(q=>({
    no:q.no,
    module:q.module,
    question:q.question,
    option:q.option,
    answer:q.answer,
    solution:q.solution,
    pm:q.pm,
    nm:q.nm,
    language:q.language
  }));

  const blob=new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="mcq.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
});

/* -------------------- REMOVE & RESET -------------------- */
$('removeLast').addEventListener('click',()=>{
  questions.pop();
  saveState();
  renderList();
});

$('resetAll').addEventListener('click',()=>{
  if(confirm("Clear all?")){
    questions=[];
    qCounter=1;
    saveState();
    renderList();
  }
});

/* -------------------- TRANSLATE -------------------- */
async function trans(t){ 
  const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=hi&tl=en&dt=t&q=${encodeURIComponent(t)}`;
  const r=await fetch(url);
  const d=await r.json();
  return d[0].map(x=>x[0]).join("");
}

$('translateAllBtn').addEventListener('click',async()=>{

  for(const q of questions){
    if(isHindi(q.question)){
      q.questionEn = await trans(q.question);
    }
    q.optionEn=[0,1,2,3].map(i=>{
      return isHindi(q.option[i]) ? null : null;
    });

    if(isHindi(q.solution)){
      q.solutionEn=await trans(q.solution);
    }
  }

  saveState();
  renderList();
  alert("Done");
});

/* -------------------- DOCX Export -------------------- */
/* (Shortened version – only fixing questionno logic) */

function escapeXml(t){
  return t.replace(/[<>&]/g,c=>({
    "<":"&lt;",">":"&gt;","&":"&amp;"
  }[c]));
}

function xmlText(t){
  if(!t) return "";
  return t.split("\n").map(x=>`<w:r><w:t>${escapeXml(x)}</w:t></w:r>`).join("<w:r><w:br/></w:r>");
}

function row(name,val){
  return `
  <w:tr>
    <w:tc><w:p>${xmlText(name)}</w:p></w:tc>
    <w:tc><w:p>${xmlText(val)}</w:p></w:tc>
  </w:tr>`;
}

function table(q){
return `
<w:tbl>
${row("Module",q.module)}
${row("questionno",String(q.no))}
${row("Question",q.question)}
${row("Option A",q.option[0])}
${row("Option B",q.option[1])}
${row("Option C",q.option[2])}
${row("Option D",q.option[3])}
${row("Answer",q.answer)}
${row("Solution",q.solution)}
${row("Language",q.language)}
</w:tbl>
<w:p/>
`;
}

$('exportBtn').addEventListener('click',()=>{

  let body="";
  questions.forEach(q=>{
    body+=table(q);

    if(q.questionEn){
      const q2={
        ...q,
        question:q.questionEn,
        option:q.optionEn,
        solution:q.solutionEn,
        language:"en",
        no:q.no   // FIX: SAME NUMBER
      };
      body+=table(q2);
    }
  });

  const xml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>${body}</w:body></w:document>`;

  const blob=new Blob([xml],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="questions.docx";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url),3000);
});

loadState();
</script>

</body>
</html>
